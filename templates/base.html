<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    {% block head %} {% endblock %}

    <!-- Bootstrap CSS -->
    <link href="{{ url_for('static', filename='css/'+settings['globals']['theme']) }}" rel="stylesheet">

    <!-- FontAwesome CSS -->
	<link href="{{ url_for('static', filename='css/all.min.css') }}" rel="stylesheet">

    <!-- WebApp Manifest -->
    <link rel="manifest" href="{{ url_for('manifest') }}">

    <!-- Favicon -->
    <link href="{{ url_for('static', filename='img/favicon.ico') }}" rel="icon" type="image/x-icon" />
    
    <!-- Apple Icons  -->
    <link rel="apple-touch-icon"  sizes="96x96" href="{{ url_for('static', filename='img/launcher-icon-2x.png') }}"/>
    <link rel="apple-touch-icon"  sizes="144x144" href="{{ url_for('static', filename='img/launcher-icon-3x.png') }}"/>
    <link rel="apple-touch-icon"  sizes="192x192" href="{{ url_for('static', filename='img/launcher-icon-4x.png') }}"/>
    
    <!-- Page Title  -->
    <title>{% block title %} {% endblock %}</title>
  </head>
  <body>
	{% block navbar %}
	<!-- Navbar Header -->
	<nav class="navbar fixed-top navbar-expand-lg navbar-dark bg-dark">
		<div class="container-fluid">
		  <a class="navbar-brand" href="/">
			<img src="{{ url_for('static', filename='img/icon.png') }}" style="width: 32px; height: auto;">
			<b>&nbsp; Process<i class="text-primary">Photos</i></b>
		  </a>
		  <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="true" aria-label="Toggle navigation">
			<span class="navbar-toggler-icon"></span>
		  </button>
		  <div class="collapse navbar-collapse" id="navbarNav">
			{% block navlinks %}
			<ul class="navbar-nav">
			  <li class="nav-item">
				<a class="nav-link active" aria-current="page" href="/">Dashboard</a>
			  </li>
			  <li class="nav-item">
				<a class="nav-link" href="/settings">Settings</a>
			  </li>
			  <li class="nav-item">
				<a class="nav-link" href="/logs">Logs</a>
			  </li>
			  <li class="nav-item">
				<a class="nav-link" href="/admin">Admin</a>
			  </li>
			</ul>
			{% endblock %}
		  </div>
	  
		</div>
	</nav>
	{% endblock %}<br><br><br><br>
	{% block notify %}
	  {% if alert is defined %}
		{% if (alert['type'] == 'success') %}
		<div class="container">
			<div class="alert alert-success alert-dismissible fade show" role="alert">
				<i class="fas fa-check-circle"></i>&nbsp; <strong>Success.</strong> {{ alert['text'] }}
				<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
			</div>
		</div>
		{% elif (alert['type'] == 'error') %} 
		<div class="container">
			<div class="alert alert-danger alert-dismissible fade show" role="alert">
				<i class="fas fa-check-circle"></i>&nbsp; <strong>Error!</strong> {{ alert['text'] }}
				<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
			</div>
		</div>
		{% elif (alert['type'] == 'warning') %} 
		<div class="container">
			<div class="alert alert-warning alert-dismissible fade show" role="alert">
				<i class="fas fa-check-circle"></i>&nbsp; <strong>Warning!</strong> {{ alert['text'] }}
				<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
			</div>
		</div>
		{% endif %}
	  {% endif %}
	  <br>
	{% endblock %}
	{% block content %} {% endblock %}<br>
	<!-- jQuery and Bootstrap Bundle (includes Popper) -->
	<script src="{{ url_for('static', filename='js/jquery-3.7.1.min.js') }}"></script>
	<script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
	{% block scripts %} {% endblock %}

	<!-- Version Pill and Process Indicator in Lower Left Corner -->
    <style>
        .version-pill {
            position: fixed;
            bottom: 10px;
            left: 10px;
            z-index: 1000;
            transition: opacity 0.3s ease;
        }
        
        .version-pill:hover .version-hover {
            opacity: 1;
        }
        
        .version-hover {
            position: absolute;
            bottom: 0;
            left: 100%;
            margin-left: 10px;
            opacity: 0;
            transition: opacity 0.3s ease;
            white-space: nowrap;
        }

        .process-indicator {
            margin-left: 10px;
            display: none;
        }
    </style>
	<div class="version-pill">
		<span class="badge rounded-pill bg-secondary">v{{ settings['versions']['server_base'] }}</span>
		<span id="process-indicator" class="badge rounded-pill bg-danger process-indicator" title="Scripts are still running in the background">
			<i class="fas fa-cog fa-spin"></i>
		</span>
		<div class="version-hover">
			<span class="badge bg-secondary">(Build {{ settings['versions']['server_build'] }})</span>
		</div>
	</div>

	<script>
		function checkRunningProcesses() {
			fetch('/check_running_processes')
				.then(response => response.json())
				.then(data => {
					const indicator = document.getElementById('process-indicator');
					if (data.has_running_processes) {
						indicator.style.display = 'inline-block';
					} else {
						indicator.style.display = 'none';
					}
				})
				.catch(error => console.error('Error checking processes:', error));
		}

		// Intercept all form submissions that trigger script runs
		document.addEventListener('submit', function(e) {
			const form = e.target;
			if (form.getAttribute('action')?.includes('/stream')) {
				e.preventDefault();
				
				fetch(form.action, {
					method: form.method,
					body: new FormData(form)
				})
				.then(response => {
					if (!response.ok) {
						return response.json().then(data => {
							throw new Error(data.message || 'An error occurred');
						});
					}
					// Handle successful response - start the EventSource
					const eventSource = new EventSource(form.action);
					// Add your existing EventSource handling here
					return null;
				})
				.catch(error => {
					alert(error.message);
				});
			}
		});

		// Check every 5 seconds
		setInterval(checkRunningProcesses, 5000);

		// Check immediately on page load
		checkRunningProcesses();
	</script>
</body>
</html>