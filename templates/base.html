<!doctype html>
<html lang="en">
  <head>
	<!-- Required meta tags -->
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	{% block head %} {% endblock %}

	<!-- Bootstrap CSS -->
	<link href="{{ url_for('static', filename='css/'+settings['globals']['theme']) }}" rel="stylesheet">

	<!-- FontAwesome CSS -->
	<link href="{{ url_for('static', filename='css/all.min.css') }}" rel="stylesheet">

	<!-- WebApp Manifest -->
	<link rel="manifest" href="{{ url_for('manifest') }}">

	<!-- Favicon -->
	<link href="{{ url_for('static', filename='img/favicon.ico') }}" rel="icon" type="image/x-icon" />
	
	<!-- Apple Icons  -->
	<link rel="apple-touch-icon"  sizes="96x96" href="{{ url_for('static', filename='img/launcher-icon-2x.png') }}"/>
	<link rel="apple-touch-icon"  sizes="144x144" href="{{ url_for('static', filename='img/launcher-icon-3x.png') }}"/>
	<link rel="apple-touch-icon"  sizes="192x192" href="{{ url_for('static', filename='img/launcher-icon-4x.png') }}"/>
	
	<!-- Page Title  -->
	<title>{% block title %} {% endblock %}</title>
  </head>
  <body>
	{% block navbar %}
	<!-- Navbar Header -->
	<nav class="navbar fixed-top navbar-expand-lg navbar-dark bg-dark">
		<div class="container-fluid">
		  <a class="navbar-brand" href="/">
			<img src="{{ url_for('static', filename='img/icon.png') }}" style="width: 32px; height: auto;">
			<b>&nbsp; Process<i class="text-primary">Photos</i></b>
		  </a>
		  <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="true" aria-label="Toggle navigation">
			<span class="navbar-toggler-icon"></span>
		  </button>
		  <div class="collapse navbar-collapse" id="navbarNav">
			{% block navlinks %}
			<ul class="navbar-nav">
			  <li class="nav-item">
				<a class="nav-link active" aria-current="page" href="/">Dashboard</a>
			  </li>
			  <li class="nav-item">
				<a class="nav-link" href="/settings">Settings</a>
			  </li>
			  <li class="nav-item">
				<a class="nav-link" href="/logs">Logs</a>
			  </li>
			  <li class="nav-item">
				<a class="nav-link" href="/admin">Admin</a>
			  </li>
			</ul>
			{% endblock %}
		  </div>
	  
		</div>
	</nav>
	{% endblock %}<br><br><br><br>
	{% block notify %}
	  {% if alert is defined %}
		{% if (alert['type'] == 'success') %}
		<div class="container">
			<div class="alert alert-success alert-dismissible fade show" role="alert">
				<i class="fas fa-check-circle"></i>&nbsp; <strong>Success.</strong> {{ alert['text'] }}
				<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
			</div>
		</div>
		{% elif (alert['type'] == 'error') %} 
		<div class="container">
			<div class="alert alert-danger alert-dismissible fade show" role="alert">
				<i class="fas fa-check-circle"></i>&nbsp; <strong>Error!</strong> {{ alert['text'] }}
				<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
			</div>
		</div>
		{% elif (alert['type'] == 'warning') %} 
		<div class="container">
			<div class="alert alert-warning alert-dismissible fade show" role="alert">
				<i class="fas fa-check-circle"></i>&nbsp; <strong>Warning!</strong> {{ alert['text'] }}
				<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
			</div>
		</div>
		{% endif %}
	  {% endif %}
	  <br>
	{% endblock %}
	{% block content %} {% endblock %}<br>
	<!-- jQuery and Bootstrap Bundle (includes Popper) -->
	<script src="{{ url_for('static', filename='js/jquery-3.7.1.min.js') }}"></script>
	<script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
	{% block scripts %} {% endblock %}

	<!-- Version Pill and Process Indicator in Lower Left Corner -->
	<style>
		.version-pill {
			position: fixed;
			bottom: 10px;
			left: 10px;
			z-index: 1000;
			transition: opacity 0.3s ease;
		}
		
		.version-pill:hover .version-hover {
			opacity: 1;
		}
		
		.version-hover {
			position: absolute;
			bottom: 0;
			left: 100%;
			margin-left: 10px;
			opacity: 0;
			transition: opacity 0.3s ease;
			white-space: nowrap;
		}

		.process-status {
			position: fixed;
			bottom: 10px;
			right: 10px;
			z-index: 1000;
			display: flex;
			align-items: center;
			transition: all 0.3s ease;
		}

		.process-status:hover .status-text {
			width: auto;
			padding: 0 10px;
			opacity: 1;
		}

		.status-text {
			width: 0;
			overflow: hidden;
			white-space: nowrap;
			opacity: 0;
			transition: all 0.3s ease;
			margin-right: 8px;
		}

		.process-indicator {
			padding: 8px;
			border-radius: 50%;
			width: 35px;
			height: 35px;
			display: flex;
			align-items: center;
			justify-content: center;
		}
	</style>
	<div class="version-pill">
		<span class="badge rounded-pill bg-secondary">v{{ settings['versions']['server_base'] }}</span>
		<div class="version-hover">
			<span class="badge bg-secondary">(Build {{ settings['versions']['server_build'] }})</span>
		</div>
	</div>

	<div class="process-status">
		<span class="status-text" id="status-message">No scripts running</span>
		<span id="process-indicator" class="badge bg-success process-indicator">
			<i class="fas fa-check"></i>
		</span>
	</div>


	<script>
		function checkRunningProcesses() {
			fetch('/check_running_processes', {
				// Prevent caching of the request
				cache: 'no-store',
				headers: {
					'Cache-Control': 'no-cache'
				}
			})
				.then(response => response.json())
				.then(data => {
					const indicator = document.getElementById('process-indicator');
					const statusMessage = document.getElementById('status-message');
					if (data.has_running_processes) {
						indicator.classList.remove('bg-success');
						indicator.classList.add('bg-danger');
						indicator.innerHTML = '<i class="fas fa-cog fa-spin"></i>';
						statusMessage.textContent = 'Scripts are running in the background';
					} else {
						indicator.classList.remove('bg-danger');
						indicator.classList.add('bg-success');
						indicator.innerHTML = '<i class="fas fa-check"></i>';
						statusMessage.textContent = 'No scripts running';
					}
				})
				.catch(error => console.error('Error checking processes:', error));
		}

		// Intercept all form submissions that trigger script runs
		document.addEventListener('submit', function(e) {
			const form = e.target;
			if (form.getAttribute('action')?.includes('/stream')) {
				e.preventDefault();
				
				const indicator = document.getElementById('process-indicator');
				const statusMessage = document.getElementById('status-message');
				
				// Set to running state immediately
				indicator.classList.remove('bg-success');
				indicator.classList.add('bg-danger');
				indicator.innerHTML = '<i class="fas fa-cog fa-spin"></i>';
				statusMessage.textContent = 'Scripts are running in the background';
				
				// Submit the form
				fetch(form.action, {
					method: form.method,
					body: new FormData(form)
				})
				.then(response => {
					if (!response.ok) {
						throw new Error('Failed to start process');
					}
					// Start checking more frequently
					const checkInterval = setInterval(checkRunningProcesses, 1000);
					// Stop frequent checking after 5 minutes
					setTimeout(() => clearInterval(checkInterval), 300000);
				})
				.catch(error => {
					console.error('Error:', error);
					alert('Error starting process: ' + error.message);
					
					// Reset indicator if there's an error
					indicator.classList.remove('bg-danger');
					indicator.classList.add('bg-success');
					indicator.innerHTML = '<i class="fas fa-check"></i>';
					statusMessage.textContent = 'No scripts running';
				});
			}
		});

		// Check every 5 seconds
		setInterval(checkRunningProcesses, 5000);

		// Check immediately on page load
		checkRunningProcesses();
	</script>
</body>
</html>